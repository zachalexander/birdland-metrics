# Birdland Metrics (formerly Launch Angle)

## Overview
Baseball analytics blog — Angular 21 SSR + Contentful CMS + d3.js visualizations.
Orioles-inspired color palette (#df4a00 orange, #1a1a1a black).

## Repo
- GitHub: https://github.com/zachalexander/birdland-metrics
- Branch: `main`
- Path: `/Users/zdalexander/Desktop/birdland-metrics/`

## Tech Stack
- Angular 21 with SSR (Express-based via `@angular/ssr`)
- Contentful Delivery API (`contentful` npm package)
- `@contentful/rich-text-html-renderer` for rich text → HTML
- d3.js for visualizations (lazy-loaded, browser-only via `isPlatformBrowser`)
- Plain CSS (no framework)
- Dockerized for AWS deployment (Fargate/App Runner)

## Contentful Schema
- **Space ID**: `btpj5jq8xkdj`
- **Content type**: `article` (not `blogPost` — this was a gotcha during setup)
- **Article fields**: title, slug, excerpt, content (RichText), coverImage (Asset link), publishedAt (Date), tags (Array<Symbol>), isPremium (Boolean), featured (Boolean)
- **Author content type**: name, bio, avatar (Asset link) — linked to articles
- `environment.ts` has placeholder values (for local dev, replace with real keys)
- `environment.prod.ts` has hardcoded Delivery API keys (read-only, safe to commit)

## Architecture
```
src/app/
├── core/services/
│   ├── contentful.service.ts              — API client, maps entries to TypeScript models
│   ├── mlb-data.service.ts                — Fetches JSON from S3 for dashboard
│   └── seo.service.ts                     — Canonical URLs, JSON-LD management, schema helpers
├── features/
│   ├── home/                              — Hero + article card grid
│   ├── article-detail/                    — Full article, rich text rendering, JSON-LD, SEO meta
│   └── article-list/                      — Category/tag filtered grid
├── shared/
│   ├── components/header|footer|article-card
│   └── models/content.models.ts           — BlogPost, Author interfaces
└── visualizations/spray-chart/            — d3.js spray chart at /visualizations/spray-chart
```

## Routes
- `/` — Home (lazy-loaded HomeComponent)
- `/articles/:slug` — Article detail (lazy-loaded)
- `/category/:category` — Filtered list (lazy-loaded)
- `/visualizations/spray-chart` — d3.js spray chart (lazy-loaded)
- All routes use `RenderMode.Server` for SSR

## SEO
- `Meta` and `Title` services set og:title, og:description, og:image, og:type, og:url, twitter:card per page
- `SeoService` manages canonical URLs (`<link rel="canonical">`) and JSON-LD schemas (uses `data-seo` attribute to prevent accumulation during SPA navigation)
- JSON-LD schemas: `BlogPosting` (with author/publisher) on article detail, `BreadcrumbList` on article detail + category list, `Organization` on all pages
- Canonical URLs set on all routes (home, article detail, category list, disclaimer, spray chart)
- `robots.txt` in `public/` (Allow all + sitemap reference)
- Dynamic `/sitemap.xml` Express route queries Contentful for all articles (static pages + category pages + article URLs with lastmod)
- `environment.ts` / `environment.prod.ts` include `siteUrl` for canonical/og:url generation
- SSR ensures meta tags and JSON-LD are in initial HTML response

## Docker
- Multi-stage Dockerfile: build with `node:20-alpine`, run with `node:20-alpine`
- Runs `node dist/birdland-metrics/server/server.mjs` on port 4000
- `.env.example` documents required env vars

## Deployment
- **Custom Domain**: https://birdlandmetrics.com (+ www.birdlandmetrics.com)
- **App Runner URL**: https://gmzjz8m6pc.us-east-1.awsapprunner.com
- **Service**: AWS App Runner `birdland-metrics` (auto-deploys on push to main)
- **Region**: us-east-1
- **Runtime**: Node.js 22
- **Instance**: 0.25 vCPU, 0.5 GB memory
- **DNS**: Route 53 hosted zone, ALIAS record for apex, CNAME for www
- **GitHub Connection**: launch-angle-github (connection ARN unchanged after repo rename)

## Current State (2026-02-11)
- 2 test articles in Contentful ("First Post", "Second Post") with cover images
- Spray chart wired to /visualizations/spray-chart with nav link in header
- Author linked to articles and displayed on article detail pages
- Tags added to articles, category filtering works
- Rebranded from "Launch Angle" to "Birdland Metrics" across all code, repo, and AWS
- Custom domain birdlandmetrics.com active with HTTPS
- Enhanced prediction model fully integrated into Lambda pipeline (FIP + shrinkage)
- Preseason WAR adjustment Lambda deployed with EventBridge schedule (every Monday in March)
- BAL preseason playoff odds: 39.0% (after WAR-based roster adjustment)
- Comprehensive model documentation at `data-pipelines/model-2026-updates/enhanced-model-reference.md`
- SEO technical gaps complete: robots.txt, dynamic sitemap.xml, canonical URLs, JSON-LD (Organization, BreadcrumbList, enhanced BlogPosting) on all routes
- Responsive images: `<picture>` with AVIF/WebP srcset on article cards (300w/600w) and article hero (600w/1200w)
- Service worker configured: `@angular/service-worker` with prefetch for app shell, lazy for images, freshness for APIs

## Completed
- ✓ Wire spray chart into dedicated route
- ✓ Add tags to Contentful articles
- ✓ Link author entries to articles in Contentful
- ✓ Deploy to AWS App Runner
- ✓ Rebrand from "Launch Angle" to "Birdland Metrics"
- ✓ Set up custom domain (birdlandmetrics.com) via Route 53
- ✓ Refactor data pipeline: 8 Lambdas → 5, shared Layer, Step Functions, latest.json outputs
- ✓ Create 2026 season infrastructure (S3 buckets, ELO baseline, EventBridge schedule)
- ✓ ELO audit: Recomputed from scratch (233K games, 1871-2025) with canonical formula, uploaded corrected baselines to S3
- ✓ Data organization audit: Cleaned S3 buckets (251→5 files in predictions, 92→14 MB in ELO, 96→32 MB in retrosheet), fixed stale DynamoDB, archived old-formula files, deleted legacy bucket
- ✓ Enhanced model prototyped and backtested: ELO + Season FIP + shrinkage (+1.89% accuracy across 3 seasons)
- ✓ Enhanced model integrated into Lambda pipeline: `fip.py` shared module, FIP fetch in `mlb-elo-compute`, FIP-adjusted probabilities + shrinkage in `mlb-season-projections`
- ✓ Lambda Layer v2 published with `mlb_common/fip.py`
- ✓ `playoff-odds-latest.json` output added (per-team division/WC/playoff %)
- ✓ Preseason WAR adjustment Lambda (`mlb-preseason-adjustment`) deployed and tested
- ✓ EventBridge schedule for preseason adjustment (every Monday in March at noon UTC)
- ✓ Model documentation: `enhanced-model-reference.md`
- ✓ SEO: robots.txt, dynamic sitemap.xml (Express route), canonical URLs on all routes
- ✓ SEO: SeoService with JSON-LD management (Organization, BreadcrumbList, enhanced BlogPosting with author/publisher)
- ✓ SEO: og:url meta tags on all routes
- ✓ Media: Responsive images with `<picture>` + AVIF/WebP sources on article cards and hero images
- ✓ Performance: Service worker (`@angular/service-worker`) with app shell prefetch, lazy image caching, API freshness caching

## Disclaimers
- ✓ Disclaimer page at `/disclaimer` with full legal text
- ✓ Footer disclaimer summary with "Learn more" link

## Refactored AWS Data Pipeline (2026)

Consolidated from 8 Lambdas → 6, orchestrated via Step Functions (5 in daily pipeline + 1 standalone preseason), with a shared Lambda Layer (v2). Test run completed 2026-02-09 (~37 seconds total). Code in `data-pipelines/`.

### Architecture
```
EventBridge (daily 6am ET, Mar–Oct) — DISABLED until season starts
  └─► Step Functions: mlb-daily-pipeline
       ├─► mlb-schedule-sync        — Fetch full season schedule → S3 CSV (~8s)
       ├─► mlb-game-results         — Fetch daily Orioles games → DynamoDB (~5s)
       ├─► mlb-elo-compute          — Recompute ELO + fetch FIP → S3 + DynamoDB (~5s)
       ├─► mlb-season-projections   — FIP-adjusted Monte Carlo sims + playoff odds → S3 (~9s)
       └─► mlb-orioles-dashboard    — Orioles GB + projections → DynamoDB + latest.json (~5s)

EventBridge (every Monday in March, noon UTC) — ENABLED
  └─► mlb-preseason-adjustment     — WAR-based ELO adjustment for offseason roster changes (~4s)
```

### ELO Formula
- K=20, HFA=55, MOV=log(|score_diff|+1) * (2.2 / (0.001*|elo_diff|+2.2))
- Win probability: 1 / (1 + 10^((elo_b - (elo_a + HFA)) / 400))
- HFA applied in both daily ELO updates AND season simulations

### Shared Lambda Layer: `mlb-pipeline-common`
- **Dependencies**: pandas, pyarrow, requests, MLB-StatsAPI
- **`mlb_common/config.py`** — All constants from env vars (season year, buckets, ELO params, FIP params)
- **`mlb_common/team_codes.py`** — Single canonical team code mapping + league/division maps
- **`mlb_common/aws_helpers.py`** — S3 read/write (CSV, JSON, Parquet) + DynamoDB helpers
- **`mlb_common/elo.py`** — ELO math (expected score, MOV multiplier, rating update)
- **`mlb_common/fip.py`** — FIP fetch from MLB API, FIP-to-ELO adjustment, probability shrinkage

### Lambda Functions (Python 3.13)
| Function | Timeout | Memory | Replaces |
|---|---|---|---|
| `mlb-schedule-sync` | 10 min | 256 MB | `mlb-remaining-2025-schedule` |
| `mlb-game-results` | 2 min | 128 MB | `mlb-stats-api-game-data` |
| `mlb-elo-compute` | 10 min | 256 MB | `mlb-daily-elo-compute` + `mlb-elo-ratings-calculator` |
| `mlb-season-projections` | 15 min | 512 MB | `mlb-season-simulations` + `mlb-stats-api-games-back-wc` |
| `mlb-orioles-dashboard` | 5 min | 256 MB | `mlb-daily-orioles-games-back` |
| `mlb-preseason-adjustment` | 2 min | 256 MB | NEW — WAR-based preseason ELO adjustment |

**Retired**: `mlb-stats-api-logos` (dead code), `mlb-elo-ratings-calculator` (duplicate ELO)

### latest.json Files for Angular Frontend
| File | Bucket | Content |
|---|---|---|
| `elo-latest.json` | `mlb-elo-ratings-output` | All 30 teams sorted by ELO |
| `fip-latest.json` | `mlb-elo-ratings-output` | League FIP + pitcher count metadata |
| `standings-latest.json` | `mlb-predictions-2026` | Projected AL standings |
| `projections-latest.json` | `mlb-predictions-2026` | Full 30-team projection summary |
| `playoff-odds-latest.json` | `mlb-predictions-2026` | Per-team playoff/division/WC percentages |
| `games-back-latest.json` | `mlb-predictions-2026` | Orioles wildcard/division GB + projections |
| `recent-games-latest.json` | `mlb-predictions-2026` | Last 10 Orioles game results |
| `preseason-adjustment-latest.json` | `mlb-elo-ratings-output` | Per-team WAR changes + ELO shifts |

### S3 Buckets
| Bucket | Files | Size | Content |
|---|---|---|---|
| `mlb-elo-ratings-output` | 4 | 14 MB | `elo-ratings-full-history.csv` (233K games, canonical formula), `elo-latest.json`, end-of-season baselines (CORS enabled) |
| `mlb-schedule-2026` | 1 | 132 KB | Full 2026 schedule CSV (CORS enabled) |
| `mlb-predictions-2026` | 7 | 307 KB | Daily projections, simulations, latest.json files (CORS enabled) |
| `mlb-schedule-2025` | 1 | 223 KB | Full 2025 schedule with scores (archive) |
| `mlb-predictions-2025` | 5 | 235 KB | Consolidated daily prediction history in `consolidated/` (archive, useful for backtesting) |
| `mlb-game-log-data-retrosheet` | 160 | 32 MB | Individual year game log zips (1871–2024) + postseason files |
| `mlb-logos-for-visuals` | 32 | 38 KB | Team logo PNGs (30 teams in named subdirectories) |
| `mlb-pipeline-artifacts` | 5 | 92 MB | Lambda layer zip + archived old-formula ELO files |

### DynamoDB Tables
| Table | Key | Content |
|---|---|---|
| `Orioles-Games` | id (game_id) | Game results (scores, pitchers, venue) |
| `Orioles-Games_Back` | id (mlb-day-{date}) | Daily wildcard/division GB + projections |
| `mlb-elo-team-ratings` | team | Current ELO per team |

### IAM Roles
| Role | Used By |
|---|---|
| `mlb-pipeline-lambda-role` | All 6 Lambda functions (S3 Full + DynamoDB Full + CloudWatch Logs) |
| `mlb-pipeline-stepfunctions-role` | Step Functions state machine |
| `mlb-pipeline-scheduler-role` | EventBridge Scheduler |

### Step Functions
- **State Machine**: `mlb-daily-pipeline`
- **ARN**: `arn:aws:states:us-east-1:953354210097:stateMachine:mlb-daily-pipeline`
- Each step retries 2x with exponential backoff

### EventBridge Schedules
- **`mlb-daily-pipeline`** — cron(0 10 * 3-10 ? *) (6am ET, Mar–Oct) — DISABLED until season starts
- **`mlb-preseason-adjustment`** — cron(0 12 ? 3 MON *) (every Monday in March, noon UTC) — ENABLED

### Season Transition Checklist
1. Extract final ratings → `elo_rating_end_of_{YEAR}.csv` (✓ done for 2025)
2. Create S3 buckets: `mlb-schedule-{YEAR+1}`, `mlb-predictions-{YEAR+1}` (✓ done for 2026)
3. Update `SEASON_YEAR` env var on all 6 Lambdas
4. Preseason adjustment runs automatically every Monday in March (✓ EventBridge enabled)
5. Enable daily pipeline EventBridge schedule on Opening Day

### Legacy Pipeline (2025 — still intact, can be deleted)
Old Lambdas: `mlb-stats-api-game-data`, `mlb-daily-elo-compute`, `mlb-elo-ratings-calculator`, `mlb-season-simulations`, `mlb-stats-api-games-back-wc`, `mlb-daily-orioles-games-back`, `mlb-remaining-2025-schedule`, `mlb-stats-api-logos`
Old EventBridge schedules: `orioles-game-check`, `mlb-elo-daily-compute`, `mlb-compute-season-simulations`, `mlb-calculate-estimated-orioles-games-back`, `mlb-remaining-schedule` (all DISABLED)
Old data access: Browser-side AWS SDK with Cognito Identity Pool (`us-east-1:e8927301-d80e-4052-9668-22f22b4f1d48`)

## Enhanced Prediction Model (2026-02-09) — ✓ DEPLOYED

Prototyped and backtested in `data-pipelines/model-2026-updates/`. Full technical reference in `enhanced-model-reference.md`. See also `model-comparison.md`.

### Model: ELO + Season FIP + Shrinkage + Preseason WAR Adjustment

**Optimal parameters** (tuned on 2025, validated out-of-sample on 2023/2024):
- `ELO_K = 20`, `ELO_HFA = 55`, `MOV_MULTIPLIER = 2.2`
- `FIP_WEIGHT = 50` (ELO points per 1 FIP unit below league avg)
- `TRAVEL_PENALTY = 10` (west-to-east, 2+ timezone shift, 1000+ miles)
- `PROB_SHRINKAGE = 0.16` (pulls probabilities toward 50% to correct overconfidence)

**3-season backtest results (vs base ELO):**
| Season | Base Acc | Enhanced Acc | Base LL | Enhanced LL |
|--------|----------|-------------|---------|-------------|
| 2023   | 55.32%   | 57.95%      | 0.6868  | 0.6780      |
| 2024   | 55.23%   | 56.84%      | 0.6891  | 0.6828      |
| 2025   | 55.76%   | 57.20%      | 0.6830  | 0.6752      |
| **Avg**| **55.44%** | **57.33% (+1.89%)** | **0.6863** | **0.6787 (-0.0076)** |

### Features Tested but Not Used (optimal weight = 0)
- **Rolling FIP** (last 7 starts): noisier than season FIP (7 starts vs 30+)
- **Bullpen FIP** (team reliever FIP): already captured by ELO through game outcomes
- **Park factors** (FanGraphs 5yr): FIP is already park-neutral by design
- **Bayesian FIP regression** (regress toward lg avg by IP): built but ineffective with end-of-season IP. Would need per-game cumulative IP to address early-season noise, but expected impact is low.
- **Per-game injury data**: prototype built (`injury_impact.py`), not yet wired into daily predictions

### Prototype Files in `data-pipelines/model-2026-updates/`
| File | Purpose |
|------|---------|
| `enhanced_model.py` | Main model — ELO + FIP + travel + shrinkage, backtest + sweep |
| `pitcher_fip.py` | Fetch season FIP for all pitchers via MLB Stats API |
| `precompute_features.py` | Rolling FIP + bullpen FIP from game logs |
| `park_factors.py` | Static FanGraphs park factors (2023-2025) |
| `ballpark_distances.py` | Haversine distances + timezone shifts for 30 parks |
| `injury_impact.py` | IL roster pull + FanGraphs WAR lookup |
| `model-comparison.md` | Detailed comparison vs FanGraphs + changelog |

### Key Learnings
- FIP is the main predictive signal beyond ELO. Travel and injuries are marginal.
- Higher shrinkage was the biggest tuning win (0.10 → 0.16). ELO+FIP is systematically overconfident.
- Season FIP (full year) beats rolling FIP (last 7 starts) — larger samples win.
- ELO already implicitly captures bullpen quality, park effects, and most roster-level info through game outcomes.
- FanGraphs projection data (ZiPS/Steamer) has commercial use restrictions. Stick to MLB Stats API for actual stats.
- Retrosheet data requires attribution.

### Lambda Integration — ✓ COMPLETE (2026-02-09)
1. ✓ `mlb_common/fip.py` — shared module: `fetch_pitcher_fip()`, `fip_adjustment()`, `apply_shrinkage()`
2. ✓ `mlb-elo-compute` — fetches bulk pitcher FIP after ELO updates, writes `pitcher_fip_{year}.csv` + `fip-latest.json`
3. ✓ `mlb-season-projections` — FIP-adjusted ELO + shrinkage for Monte Carlo sims and next-game predictions
4. ✓ `playoff-odds-latest.json` — per-team division/WC/playoff percentages from 10k sims
5. ✓ Lambda Layer v2 published with `fip.py` module
6. ✓ Full pipeline tested end-to-end (~37s)

### Preseason WAR Adjustment — ✓ COMPLETE (2026-02-09)
- `mlb-preseason-adjustment` Lambda: adjusts ELO baseline for offseason roster changes
- WAR computed from MLB Stats API (wOBA batting + FIP pitching, no pybaseball dependency)
- 3-year WAR average, WAR_TO_ELO = 5.5
- Idempotent: backs up original baseline as `_raw.csv`, re-reads from raw on repeat runs
- EventBridge: every Monday in March at noon UTC (ENABLED)
- Outputs: adjusted baseline, `preseason-adjustment-latest.json`
- Prototype with FanGraphs WAR: `model-2026-updates/preseason_adjustment.py`

### Homepage Vision
- **Headline metric**: Orioles playoff probability (updated daily)
- **AL Standings table**: Projected final standings, updated as season progresses
- **Recent games**: Last 10 Orioles games with model's pre-game win probability vs actual result
- **WAR visualization**: Player-level contribution chart (build from MLB Stats API data to avoid FanGraphs licensing concerns, or use WAR with attribution for editorial purposes)

## UX/UI Roadmap

Strategy: daily-updating d3 visualizations on the home page as the primary hook for return visits, with deeper visualizations embedded in articles for a dashboard + editorial hybrid.
Benchmarks: Baseball Savant (inline viz, dashboard home), FanGraphs (taxonomy/filtering), The Ringer (editorial layout), Pitcher List (newsletter-first growth), Baseball Prospectus (premium gating, related articles).

### Phase 1: Data Pipeline Integration + Home Dashboard (highest impact)

**Data pipeline — ✓ COMPLETE (2026-02-06 → 2026-02-09):**
- ✓ Refactored 8 Lambdas → 6 with shared Layer v2, Step Functions orchestration
- ✓ All Lambdas write `latest.json` files to S3 for Angular frontend
- ✓ CORS enabled on S3 buckets
- ✓ 2026 S3 buckets created (`mlb-schedule-2026`, `mlb-predictions-2026`)
- ✓ End-of-2025 ELO baseline created
- ✓ EventBridge schedules configured (daily pipeline + preseason adjustment)
- ✓ Enhanced model deployed (FIP + shrinkage in pipeline, preseason WAR adjustment)
- ✓ Full pipeline test successful (~37 seconds)
- ✓ **ELO Audit (2026-02-07)**: Recomputed all ratings from scratch (233K games, canonical formula). Corrected baselines uploaded.
- ✓ **Data Audit (2026-02-08)**: Cleaned S3 buckets, fixed stale DynamoDB, archived old files.
- ✓ **Model Documentation (2026-02-09)**: `enhanced-model-reference.md` for blog article reference.

**Angular work — NEXT UP:**
- Create `MlbDataService` (`src/app/core/services/mlb-data.service.ts`) — fetches JSON from S3
- Build 3 home page dashboard components:
  1. **Games Back chart** — port existing d3 line chart (wildcard + division lines, projection cone)
  2. **AL Standings table** — projected end-of-season standings
  3. **Recent Games scoreboard** — last 10 Orioles games with logos/scores/pitchers
- Redesign home page: dashboard section on top → article grid below

### Phase 2: Article Experience + Deeper Viz
- Add reading time on article cards and detail pages (`Math.ceil(wordCount / 200)`)
- Add "Related Articles" section at bottom of article detail (2-3 cards, same tags)
- Add breadcrumbs on article detail and category pages
- Build reusable d3 visualization components for embedding in articles (ELO trends, simulation distributions, matchup analysis)
- Add category nav to header (dropdown or sub-nav exposing tag taxonomy)

### Phase 3: Engagement & Growth
- Newsletter CTA in 3 spots: home (between sections), article footer, subtle sticky banner
- Social share buttons on article detail (Twitter/X, Facebook, copy link)
- Author profile cards at end of articles (avatar, bio, link to all their posts)
- Set up newsletter for email capture (Buttondown or ConvertKit)

### Phase 4: Polish & Delight
- Search (Contentful full-text search in header)
- Table of contents for long-form articles (sticky sidebar on desktop)
- Dark mode toggle (palette already exists in header/footer)
- `prefers-reduced-motion` media queries (skeleton shimmer, hover transitions, spray chart)
- Print stylesheet for long articles
- Skip-to-content link and focus styles for accessibility
- Second responsive breakpoint at 1024px (tablet: 2-column grid)
- Pagination or "Load more" for article grid

### Phase 5: Monetization-Ready
- Premium content gate (isPremium field already in Contentful)
- Membership tiers (Stripe or Patreon)
- Affiliate placements styled as "recommended tools" cards within articles
- Sponsored content styling distinct from editorial

## Technical Gaps (after UX/UI phases) — ✓ COMPLETE (2026-02-11)

### Media / Images — ✓ COMPLETE
- ✓ `<picture>` elements with AVIF/WebP `<source>` + srcset breakpoints on article cards (300w/600w) and article detail hero (600w/1200w)
- ✓ Contentful image format params (`&fm=avif`, `&fm=webp`) for modern formats

### SEO — ✓ COMPLETE
- ✓ `robots.txt` (static in `public/`)
- ✓ `sitemap.xml` (dynamic Express route, queries Contentful for articles + categories)
- ✓ Canonical URL tags on all routes via `SeoService.setCanonicalUrl()`
- ✓ `Organization` JSON-LD on all pages
- ✓ `BreadcrumbList` JSON-LD on article detail and category list pages
- ✓ Enhanced `BlogPosting` JSON-LD with author (Person), publisher (Organization with logo), URL
- ✓ `og:url` meta tags on all routes
- ✓ `SeoService` (`src/app/core/services/seo.service.ts`) — manages canonical links + JSON-LD with `data-seo` attribute to prevent script accumulation

### Performance — ✓ COMPLETE
- ✓ Service worker via `@angular/service-worker` (production only, registerWhenStable:30000)
- ✓ `ngsw-config.json`: app shell prefetch, lazy image caching, Contentful API freshness (5s timeout, 1h cache), Contentful images performance (30d cache), S3 data freshness (5s timeout, 6h cache)
